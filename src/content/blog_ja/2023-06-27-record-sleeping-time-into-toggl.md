---
title: "【Python】睡眠時間をtogglに自動で記録する"
slug: "record-sleeping-time-into-toggl"
description: ""
date: 2023-06-27T16:59:36.201Z
preview: "https://pub-21c8df4785a6478092d6eb23a55a5c42.r2.dev/img/eyecatch/garmin_toggl.webp"
draft: false
tags: ['Python', 'toggl', 'API']
categories: ['Programming']
---

<p>Pythonを使って、togglに睡眠時間を自動で書きだすプログラムをつくります。</p><h2 id="h9707d3a59a">概要</h2><p>自由な時間やゆっくりできる時間を絞り出すためにタスク管理ツールをいくつか使っています。メインツールとして<a href="https://draft.blogger.com/blog/post/edit/3231669075263956300/5316291686161534869?hl=ja#">TickTick</a>などをつかって、完了したタスクの内容は把握しています。一方で、それぞれにどれだけ時間を費やしたかInput量が見えづらいことに気付きました。<br>Inputが見えずらい点に関して、<a href="https://draft.blogger.com/blog/post/edit/3231669075263956300/5316291686161534869?hl=ja#">toggl</a>というツールを使うとストップウォッチのように手軽に時間を測りながら、やった作業内容をクイックに記録できます。APIもあるので、自動でデータを蓄積することもできます。加えて、CSV出力機能もついているので、データをためて分析するところまで手軽にできることになります。<br>手始めに、スマートウォッチに蓄積されている睡眠時間を自動でtogglに登録する処理を書き、APIに少しずつ慣れていきます。</p><h2 id="h18a86fe6b9">Inputデータ</h2><p>スマートウォッチはGarminのVenu 2を使います。</p><p>GarminはOfficialなAPIは公開されていませんが、<a href="https://draft.blogger.com/blog/post/edit/3231669075263956300/5316291686161534869?hl=ja#">APIを叩けるライブラリ</a>は存在します。これを使って、睡眠ログを取得して、toggl API用にデータを変換します。今回はGarminのウォッチを使いますが、Fitbitであれば<a href="https://draft.blogger.com/blog/post/edit/3231669075263956300/5316291686161534869?hl=ja#">OfficialなAPI</a>もあります。</p><p>他社製品なので、APIからのReturnは異なりますが睡眠の記録を取得できます。睡眠時間の記録に関しては、データ取得さえできればほかのウォッチでも良いと思われます。</p><p>また、データを変えれば睡眠に限らずにいろいろなデータを流し込めるので、他のAPIで運動時間など人の作業を記録したり、他に何か人に限らずとも時間を記録する用途で使うのも面白いかもしれません。</p><h2 id="h30fa20b7e1">コーディング</h2><p>今回書いたコードのRepositoryは以下のURLです。<br><a href="https://draft.blogger.com/blog/post/edit/3231669075263956300/5316291686161534869?hl=ja#">https://github.com/rmc8/Tool-for-transcribing-sleep-records-to-toggl</a></p><h3 id="h9e5ec7394d">Main</h3><p>メインの処理は<a href="https://draft.blogger.com/blog/post/edit/3231669075263956300/5316291686161534869?hl=ja#">main.py</a>に書きました。YAML形式のファイルやコマンドラインから設定を引き取りプログラムを実行します。</p><p>コマンドラインは以下のような構成です。</p><pre><code class="language-shell hljs">python <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.py</span> {さかのぼる日付数}
</code></pre><p>コマンドラインでさかのぼる日数に<code>1</code>と入力すると、プログラム実行日から前日の範囲、<code>30</code>と入力すると同様に30日前までの範囲の睡眠記録をまとめて取得を試みます。引数を省略すると当日分のみを取得を試みます。日数指定できないのは不便な気もしますが、タスクスケジューラーで自動的に登録しておしまいにしたいので、かなり簡素化しています。</p><p>YAMLファイルは以下の通りです。</p><pre><code class="language-yaml hljs"><span class="hljs-attr">time_zone:</span> <span class="hljs-number">9</span>  
<span class="hljs-attr">toggl:</span>  
  <span class="hljs-attr">token:</span> <span class="hljs-comment"># Required  </span>
  <span class="hljs-attr">time_entry:</span>  
  <span class="hljs-attr">workspace_id:</span>  
  <span class="hljs-attr">project_id:</span>  
  <span class="hljs-attr">task_id:</span>  
  <span class="hljs-attr">billable:</span> <span class="hljs-literal">False</span> <span class="hljs-comment"># Not required  </span>
  <span class="hljs-attr">tags:</span>  
  <span class="hljs-bullet">-</span> <span class="hljs-string">睡眠</span>  
<span class="hljs-attr">garmin:</span>  
  <span class="hljs-attr">email:</span> <span class="hljs-comment"># Required  </span>
  <span class="hljs-attr">password:</span> <span class="hljs-comment"># Required</span>
</code></pre><p>YAMLの読み込みはutil.pyでPyYAMLを使って実装しています。YAMLファイルを辞書形式で読み込める便利なライブラリです。この設定ファイルの内容はすべてAPIに流し込む値とです。time_zoneはUTC基準でどれだけ時差があるかを入力します。その他は、後述で説明します。</p><p>その後、GarminのAPIから睡眠時間を取得し、toggl用にデータを変換してAPIを通じてtogglに睡眠時間を登録する作業をします。その後、togglAPIからのResponseを、<code>./output</code>にcsv形式で出力します。</p><h3 id="h191d0c9280">Garmin API</h3><p><a href="https://draft.blogger.com/blog/post/edit/3231669075263956300/5316291686161534869?hl=ja#">https://github.com/rmc8/Tool-for-transcribing-sleep-records-to-toggl/blob/main/pkg/garmin.py</a></p><p>Garminからのデータ取得は、冒頭の通り<a href="https://draft.blogger.com/blog/post/edit/3231669075263956300/5316291686161534869?hl=ja#">非公式のライブラリ</a>を使います。そのため、リポジトリのREADMEやソースコード、デベロッパ―ツールを使った解析以外にデータの取得の手掛かりはありません。ソースコードを読むと、EndpointやPOST内容などもわかりますが、今回は割愛します。</p><h4 id="h13055cb0bb">APIへの接続</h4><pre><code class="language-python hljs"><span class="hljs-keyword">class</span> GarminAPI:  
 def <span class="hljs-constructor">__init__(<span class="hljs-params">self</span>, <span class="hljs-params">email</span>: <span class="hljs-params">str</span>, <span class="hljs-params">password</span>: <span class="hljs-params">str</span>, <span class="hljs-params">time_deff</span>: <span class="hljs-params">int</span> = 9)</span>:  
  self.client = <span class="hljs-constructor">Garmin(<span class="hljs-params">email</span>, <span class="hljs-params">password</span>)</span>  
  self.client.login<span class="hljs-literal">()</span>  
  self.time_deff: <span class="hljs-built_in">int</span> = time_deff
</code></pre><p>GarminAPIクラスを呼び出しと同時に、APIに接続します。認証はGarmin Connectのユーザー情報と同じです。メールアドレスとパスワードを<code>config.yml</code>に記載します。Garmin APIからのReturnがUTC（GMT）なので、時差調整できるように一応<code>time_deff</code>を加えました。</p><h4 id="hd23087fde4">睡眠ログの取得</h4><p><code>get_sleep_logs</code>メソッドを使ってまとめて睡眠情報を取得します。カプセル化により隠蔽されていますが、garminconnectライブラリで用意されている<code>get_sleep_data</code>メソッドを使うとサクッと睡眠時間を含んだJSONを取得できます。<br>そのJSONの<code>dailySleepDTO</code>の値に、就寝時間と起床時間をエポック秒（GMT）形式で格納されています。これを、Pythonのdatetimeの形に変換して、時差を調整する作業を以下で行っています。</p><pre><code class="language-python hljs"><span class="hljs-meta">@staticmethod</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">epoc2date</span>(<span class="hljs-params">epoc: <span class="hljs-built_in">int</span>, time_deff: <span class="hljs-built_in">int</span></span>):
 dt = datetime.fromtimestamp(epoc / <span class="hljs-number">1000</span>)
 <span class="hljs-keyword">return</span> dt + timedelta(hours=time_deff)

start = self.epoc2date(display[<span class="hljs-string">"sleepStartTimestampGMT"</span>], self.time_deff)
end = self.epoc2date(display[<span class="hljs-string">"sleepEndTimestampGMT"</span>], self.time_deff)
</code></pre><p>その後、toggl用にデータを変換しています。辞書の内容は以下の通りです。</p><table><tbody><tr><th colspan="1" rowspan="1"><p>Key</p></th><th colspan="1" rowspan="1"><p>Value</p></th><th colspan="1" rowspan="1"><p>Description</p></th></tr><tr><td colspan="1" rowspan="1"><p>date</p></td><td colspan="1" rowspan="1"><p>寝た日</p></td><td colspan="1" rowspan="1"><p>使わないけど参考程度に</p></td></tr><tr><td colspan="1" rowspan="1"><p>description</p></td><td colspan="1" rowspan="1"><p>説明</p></td><td colspan="1" rowspan="1"><p>ここではいつ寝たか説明文として書いています。<br>今回はTitleと思っていただいて大丈夫そうです。</p></td></tr><tr><td colspan="1" rowspan="1"><p>start</p></td><td colspan="1" rowspan="1"><p>開始時間</p></td><td colspan="1" rowspan="1"><p>ここでは就寝時間がこれにあたります。</p></td></tr><tr><td colspan="1" rowspan="1"><p>stop</p></td><td colspan="1" rowspan="1"><p>終了時間</p></td><td colspan="1" rowspan="1"><p>ここでは起床時間がこれにあたります。</p></td></tr><tr><td colspan="1" rowspan="1"><p>duration</p></td><td colspan="1" rowspan="1"><p>経過時間</p></td><td colspan="1" rowspan="1"><p>どれぐらいの時間が経過したか秒数で書きます。</p></td></tr></tbody></table><p><code>duration</code>はtogglの公式ドキュメントで小難しい説明がされていますが、下図の黄色マーカーの箇所の表示に使われます。</p><p><br></p><p></p><p>マイナスもあり得るとよくわからないことも書いてありますが、これをうまく使うと睡眠時間の間に眠れず起きていた時間を差し引いた時間を埋め込むような使い方もできます。その他は特にトリッキーなものではないので一旦省略します。</p><p>すべての日付をさかのぼり睡眠時間などをまとめたデータが完成したら、Pandasのデータフレーム形式に変換して<code>main.py</code>に返します。</p><h3 id="hb8761e8974">toggl API</h3><p><a href="https://draft.blogger.com/blog/post/edit/3231669075263956300/5316291686161534869?hl=ja#">https://github.com/rmc8/Tool-for-transcribing-sleep-records-to-toggl/blob/main/pkg/toggl.py</a></p><p>toggl APIは<a href="https://draft.blogger.com/blog/post/edit/3231669075263956300/5316291686161534869?hl=ja#">GitHub</a>にまとめられています。Pythonのクライアントもあるようですが、PyPIから取得できず使い方もソースコード読まないとわからない気がしたので、ドキュメントをもとに必要な処理だけ自前で書きました。</p><p>APIの認証にはトークンを使います。<a href="https://draft.blogger.com/blog/post/edit/3231669075263956300/5316291686161534869?hl=ja#">Profileページ</a>の下方にトークンがあります。これを、config.ymlの<code>toggl &gt; token</code>に記載します。その他、<code>toggl &gt; time_entry</code>内の3種類のIDは特定の場所に記録したい場合に記載します。<code>billable</code>は睡眠が直接利益を生み出すわけでもないので、基本的にはFalseで良いでしょう。その他、<code>tags</code>はリスト形式でタグを複数設定できます。一旦のところ、<code>- 睡眠</code>で一つだけタグを設定しています。</p><h4 id="he45ecfd0c2">toggleに記録する</h4><p><code>create_time_entry</code>メソッドを使うと、togglに睡眠時間を記録します。必須の値を中心に引数で引き取り、その他はキーワード引数とアンパックを使って必要に応じて追加できるようにしています。<br><code>stop</code>は必須ではないですが、duration周りがトリッキーで<code>stop</code>がないと終了時間がずれがちなので、時間を明示できるように入れました。</p><p>その後、ドキュメントに従ったJSON Payloadっぽいものが生成されるので、これを<code>_request</code>メソッドに投げ込み、API経由でまとめて睡眠時間を登録します。</p><h3 id="h16ceed364c">ログ出力</h3><p><code>./output</code>ディレクトリにAPIの結果をCSV形式で出力します。サンプルは以下の通りです。</p><pre><code class="language-csv hljs"><span class="hljs-attribute">id</span>,wid,billable,start,stop,duration,description,tags,duronly,at,uid
<span class="hljs-attribute">2xxxxxxxxx</span>,<span class="hljs-number">5</span>xxxxxxxx,False,<span class="hljs-number">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">25</span>T23:<span class="hljs-number">46</span>:<span class="hljs-number">00</span>.<span class="hljs-number">000</span>+<span class="hljs-number">09</span>:<span class="hljs-number">00</span>,<span class="hljs-number">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">26</span>T06:<span class="hljs-number">56</span>:<span class="hljs-number">00</span>.<span class="hljs-number">000</span>+<span class="hljs-number">09</span>:<span class="hljs-number">00</span>,<span class="hljs-number">25800</span>,Sleep time <span class="hljs-literal">on</span> <span class="hljs-number">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">25</span>,['睡眠'],False,<span class="hljs-number">2021</span>-<span class="hljs-number">09</span>-<span class="hljs-number">26</span>T08:<span class="hljs-number">59</span>:<span class="hljs-number">03</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>,<span class="hljs-number">7</span>xxxxxxxx</code></pre><h2 id="h6eac5e0dfa">今後の応用</h2><p>睡眠時間を自動で登録することはできました。これと同じように、スマートウォッチやIoTの活用で自動登録できるものは、まず自動登録を進めたいです。</p><p>TickTickはGASやらIFTTTやら連携させつつ、重要なタスクは手動で登録させたりなどして、やることをまとめています。これをAPIで取得して、やっているタスクを選びストップウォッチを（<br>起動・停止）・（完了・未完）の制御ができると、InputとOutputの管理がしやすくなりそうです。</p><p>その他、APIが使えない部分はアプリの機能がとてもシンプルなのでそれをそのまま使えばだいぶタスクの管理や分析が楽になりそうです。</p><p>普通にtogglアプリを使う以外はまだまだコーディングが必要ですが、ありあわせのものを再利用しつつAPIで連携でき、しかもクラウドですべての端末で情報共有もできます。個人利用なら無料で使えて必要十分以上の機能なのでとてもありがたいです。</p><h2 id="ha214098e44">まとめ</h2><p>時間を管理し分析するプラットフォームとしてtogglはとても良いです。日本語の対応はまだまだですが、英語にアレルギーがなければ非常に有用で拡張性の高いツールだと思います。ぜひ、色々なIoT機器やAPIなどと組み合わせて遊んでみてください。</p>
